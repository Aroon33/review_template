<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>CryptoX Admin - å…¥é‡‘ç”³è«‹ç®¡ç†</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #f3f4f6;
      --bg-soft: #ffffff;
      --primary: #1652f0;
      --primary-soft: #e5edff;
      --text-main: #111827;
      --text-muted: #6b7280;
      --border-soft: #e5e7eb;
      --danger: #dc2626;
      --success: #16a34a;
      --pending: #f97316;
    }
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    body { background: var(--bg); color: var(--text-main); }
    a { text-decoration: none; color: inherit; }

    .admin-header {
      position: fixed; top:0; left:0; right:0;
      height:52px; background:#fff;
      border-bottom:1px solid var(--border-soft);
      display:flex; align-items:center; justify-content:space-between;
      padding:0 18px 0 60px; z-index:30;
    }
    .admin-header-left { display:flex; align-items:center; gap:10px; }
    .logo-badge {
      width:26px; height:26px; border-radius:8px;
      background:var(--primary); color:#fff;
      display:flex; align-items:center; justify-content:center;
      font-size:14px; font-weight:700;
    }
    .logo-text { font-weight:700; font-size:16px; }
    .logo-sub { font-size:11px; color:var(--text-muted); }
    .admin-header-right { display:flex; align-items:center; gap:10px; font-size:11px; color:var(--text-muted); }
    .btn {
      border-radius:999px; padding:6px 12px;
      font-size:11px; border:1px solid transparent;
      background:transparent; cursor:pointer;
    }
    .btn-outline { border-color:var(--border-soft); background:#fff; color:var(--text-main); }
    .btn-sm { padding:4px 10px; font-size:11px; }

    .sidebar {
      position:fixed; top:0; left:0; bottom:0;
      width:200px; background:#0f172a; color:#e5e7eb;
      padding-top:52px; display:flex; flex-direction:column;
      border-right:1px solid #020617; z-index:20;
    }
    .sidebar-title {
      padding:10px 14px; font-size:11px;
      text-transform:uppercase; letter-spacing:0.08em;
      color:#6b7280;
    }
    .nav-list { list-style:none; margin:0; padding:0 8px 12px; }
    .nav-item { margin-bottom:4px; }
    .nav-link {
      display:flex; align-items:center; gap:8px;
      padding:7px 8px; border-radius:8px;
      font-size:12px; color:#9ca3af; cursor:pointer;
    }
    .nav-link:hover { background:rgba(148,163,184,0.15); color:#e5e7eb; }
    .nav-link.active {
      background:#111827; color:#e5e7eb;
      border:1px solid rgba(129,140,248,0.5);
    }
    .nav-icon { width:14px; text-align:center; font-size:12px; }
    .sidebar-footer {
      margin-top:auto; padding:10px 14px 12px;
      font-size:11px; color:#6b7280;
      border-top:1px solid rgba(31,41,55,0.9);
    }

    .main { margin-left:200px; padding-top:52px; }
    .main-inner { max-width:1120px; margin:0 auto; padding:16px 18px 24px; }
    .page-title { font-size:16px; font-weight:600; margin-bottom:4px; }
    .page-sub { font-size:11px; color:var(--text-muted); margin-bottom:10px; }

    .filters-card {
      background:#fff; border-radius:10px; border:1px solid var(--border-soft);
      padding:10px 12px 8px; box-shadow:0 1px 2px rgba(15,23,42,0.03);
      margin-bottom:10px;
    }
    .filters-row {
      display:flex; justify-content:space-between; align-items:center;
      margin-bottom:8px;
    }
    .filters-title { font-size:13px; font-weight:600; }
    .filters-meta { font-size:11px; color:var(--text-muted); }
    .filters-grid {
      display:grid; grid-template-columns:minmax(0,0.9fr) minmax(0,0.7fr) minmax(0,0.6fr);
      gap:8px;
    }
    @media (max-width:900px){ .filters-grid{ grid-template-columns:1fr; } }
    .field {
      display:flex; flex-direction:column; gap:2px;
      font-size:11px;
    }
    .field label { color:var(--text-muted); }
    .field input, .field select {
      border-radius:6px; border:1px solid var(--border-soft);
      padding:6px 7px; font-size:11px; outline:none; background:#fff;
    }
    .field input:focus, .field select:focus { border-color:var(--primary); }

    .status-tabs {
      display:inline-flex; border-radius:999px;
      border:1px solid var(--border-soft); overflow:hidden;
      font-size:11px;
    }
    .status-tab-btn {
      padding:4px 10px; border:none;
      background:#fff; color:var(--text-muted);
      cursor:pointer;
    }
    .status-tab-btn.active { background:var(--primary); color:#fff; }

    .pane-grid {
      display:grid; grid-template-columns:minmax(0,0.9fr) minmax(0,1.3fr);
      gap:10px;
    }
    @media (max-width:900px){ .pane-grid{ grid-template-columns:1fr; } }

    .card {
      background:#fff; border-radius:10px;
      border:1px solid var(--border-soft);
      box-shadow:0 1px 2px rgba(15,23,42,0.03);
      padding:10px 11px 9px; font-size:12px;
    }
    .card-header-row {
      display:flex; justify-content:space-between; align-items:center;
      margin-bottom:6px;
    }
    .card-title-small { font-size:13px; font-weight:600; }
    .card-sub-small { font-size:11px; color:var(--text-muted); }

    .list-box {
      max-height:420px; overflow-y:auto;
      border-radius:8px; border:1px solid #e5e7eb;
      background:#f9fafb;
    }
    .item-row {
      padding:7px 8px; border-bottom:1px solid #e5e7eb;
      cursor:pointer; display:flex; justify-content:space-between;
      align-items:flex-start; gap:8px; background:#fff;
    }
    .item-row:nth-child(2n){ background:#f9fafb; }
    .item-row:last-child{ border-bottom:none; }
    .item-row.active { background:#eef2ff; border-left:3px solid var(--primary); }
    .item-title { font-size:12px; font-weight:600; margin-bottom:2px; }
    .item-meta { font-size:11px; color:var(--text-muted); }

    .status-chip {
      display:inline-flex; align-items:center;
      border-radius:999px; padding:2px 8px;
      font-size:10px; font-weight:500;
    }
    .status-pending { background:#ffedd5; color:var(--pending); }
    .status-completed { background:#dcfce7; color:var(--success); }
    .status-user_cancel,
    .status-admin_cancel { background:#fee2e2; color:var(--danger); }

    .detail-header {
      display:flex; justify-content:space-between; align-items:flex-start;
      gap:8px; margin-bottom:6px;
    }
    .detail-title { font-size:13px; font-weight:600; margin-bottom:2px; }
    .detail-meta { font-size:11px; color:var(--text-muted); }
    .detail-meta span{ margin-right:8px; }

    .status-select {
      font-size:11px; padding:4px 6px;
      border-radius:6px; border:1px solid var(--border-soft); outline:none;
    }
    .status-select:focus{ border-color:var(--primary); }

    .info-grid {
      display:grid; grid-template-columns:repeat(2,minmax(0,1fr));
      gap:8px; margin-top:4px;
    }
    @media (max-width:800px){ .info-grid{ grid-template-columns:1fr; } }
    .info-block {
      border-radius:8px; border:1px solid var(--border-soft);
      padding:8px 9px; background:#f9fafb; font-size:11px;
    }
    .info-label { font-size:11px; color:var(--text-muted); margin-bottom:3px; }
    .info-value { font-size:12px; font-weight:600; }

    .wallet-row { font-size:11px; margin-top:2px; }
    .wallet-row span { margin-right:8px; }

    .toolbar {
      display:flex; justify-content:flex-end; gap:6px; margin-top:8px;
    }
    .btn-xs {
      padding:5px 10px; border-radius:999px;
      font-size:11px; cursor:pointer; border:1px solid var(--border-soft);
      background:#fff;
    }
    .btn-xs-primary {
      background:var(--primary); color:#fff; border-color:var(--primary);
    }

    .note { font-size:10px; color:var(--text-muted); margin-top:4px; }

    .toast {
      position:fixed; right:16px; bottom:16px;
      background:#111827; color:#f9fafb;
      padding:8px 14px; border-radius:999px;
      font-size:11px; display:none; z-index:50;
    }
    .toast.show{ display:block; }

    @media (max-width:768px){
      .admin-header{ padding-left:54px; }
      .sidebar{ width:180px; }
      .main{ margin-left:180px; }
    }
    @media (max-width:640px){
      .sidebar{ transform:translateX(-100%); }
      .main{ margin-left:0; }
      .admin-header{ padding-left:12px; }
    }
  </style>
</head>
<body>
  <aside class="sidebar">
    <div class="sidebar-title">ãƒ¡ãƒ‹ãƒ¥ãƒ¼</div>
    <ul class="nav-list">
      <li class="nav-item"><a href="index.html" class="nav-link"><span class="nav-icon">ğŸ </span><span>ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</span></a></li>
      <li class="nav-item"><a href="tickets.html" class="nav-link"><span class="nav-icon">ğŸ’¬</span><span>å•ã„åˆã‚ã›ç®¡ç†</span></a></li>
      <li class="nav-item"><a href="users.html" class="nav-link"><span class="nav-icon">ğŸ‘¥</span><span>ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§</span></a></li>
      <li class="nav-item"><a href="trades.html" class="nav-link"><span class="nav-icon">ğŸ“Š</span><span>å–å¼•çŠ¶æ³</span></a></li>
      <li class="nav-item"><a href="kyc.html" class="nav-link"><span class="nav-icon">ğŸ“Š</span><span>KYCçŠ¶æ³</span></a></li>
      <li class="nav-item"><a href="deposit.html" class="nav-link active"><span class="nav-icon">â•</span><span>å…¥é‡‘ç”³è«‹</span></a></li>
      <li class="nav-item"><a href="withdraw.html" class="nav-link"><span class="nav-icon">â–</span><span>å‡ºé‡‘ç”³è«‹</span></a></li>
      <li class="nav-item"><a href="group.html" class="nav-link"><span class="nav-icon">ğŸ§©</span><span>ã‚°ãƒ«ãƒ¼ãƒ—ç®¡ç†</span></a></li>
      <li class="nav-item"><a href="settings.html" class="nav-link"><span class="nav-icon">âš™ï¸</span><span>ã‚·ã‚¹ãƒ†ãƒ è¨­å®š</span></a></li>
    </ul>
    <div class="sidebar-footer">CryptoX Admin<br>UI Demo &copy; 2025</div>
  </aside>

  <header class="admin-header">
    <div class="admin-header-left">
      <div class="logo-badge">AX</div>
      <div>
        <div class="logo-text">Admin Console</div>
        <div class="logo-sub">å…¥é‡‘ç”³è«‹ç®¡ç†</div>
      </div>
    </div>
    <div class="admin-header-right">
      <span>ç®¡ç†è€…ï¼šadmin@example.com</span>
      <button class="btn btn-outline btn-sm" onclick="location.href='login.html'">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆï¼ˆãƒ‡ãƒ¢ï¼‰</button>
    </div>
  </header>

  <main class="main">
    <div class="main-inner">
      <div class="page-title">å…¥é‡‘ç”³è«‹ç®¡ç†</div>
      <div class="page-sub">
        ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®å…¥é‡‘ç”³è«‹ã‚’ä¸€è¦§ãƒ»æ¤œç´¢ã—ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´ã«å¿œã˜ã¦æ®‹é«˜ã¸åæ˜ ã™ã‚‹ãƒ‡ãƒ¢ç”»é¢ã§ã™ã€‚
      </div>

      <section class="filters-card">
        <div class="filters-row">
          <div>
            <div class="filters-title">ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</div>
            <div class="filters-meta">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ»é€šè²¨ãƒ»æœŸé–“ã§å…¥é‡‘ç”³è«‹ã‚’çµã‚Šè¾¼ã¿ã¾ã™ã€‚</div>
          </div>
          <div class="status-tabs">
            <button class="status-tab-btn active" data-status="all">ã™ã¹ã¦</button>
            <button class="status-tab-btn" data-status="pending">ç”³è«‹ä¸­</button>
            <button class="status-tab-btn" data-status="completed">å®Œäº†</button>
            <button class="status-tab-btn" data-status="user_cancel">ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button class="status-tab-btn" data-status="admin_cancel">ç®¡ç†å´ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          </div>
        </div>
        <div class="filters-grid">
          <div class="field">
            <label>ãƒ¦ãƒ¼ã‚¶ãƒ¼ID</label>
            <input type="text" id="f-user" placeholder="ä¾‹ï¼šuser-demo-001" />
          </div>
          <div class="field">
            <label>é€šè²¨</label>
            <select id="f-currency">
              <option value="all">ã™ã¹ã¦</option>
              <option value="JPY">JPY</option>
              <option value="BTC">BTC</option>
              <option value="ETH">ETH</option>
              <option value="USDT">USDT</option>
            </select>
          </div>
          <div class="field">
            <label>æœŸé–“ï¼ˆFromï¼‰</label>
            <input type="date" id="f-from" />
          </div>
          <div class="field">
            <label>æœŸé–“ï¼ˆToï¼‰</label>
            <input type="date" id="f-to" />
          </div>
        </div>
      </section>

      <section class="pane-grid">
        <!-- å·¦ï¼šä¸€è¦§ -->
        <div class="card">
          <div class="card-header-row">
            <div>
              <div class="card-title-small">å…¥é‡‘ç”³è«‹ä¸€è¦§</div>
              <div class="card-sub-small" id="list-count">0ä»¶</div>
            </div>
            <button class="btn-xs" id="btn-refresh">å†èª­ã¿è¾¼ã¿</button>
          </div>
          <div class="list-box" id="list-box"></div>
        </div>

        <!-- å³ï¼šè©³ç´° -->
        <div class="card">
          <div class="detail-header">
            <div>
              <div class="detail-title" id="detail-title">ç”³è«‹ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
              <div class="detail-meta" id="detail-meta">
                å·¦ã®ä¸€è¦§ã‹ã‚‰å…¥é‡‘ç”³è«‹ã‚’é¸æŠã™ã‚‹ã¨ã€è©³ç´°ã¨æ®‹é«˜ã®åæ˜ çŠ¶æ³ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
              </div>
            </div>
            <div>
              <div style="font-size:11px; color:var(--text-muted); margin-bottom:2px;">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</div>
              <select class="status-select" id="status-select" disabled>
                <option value="pending">ç”³è«‹ä¸­</option>
                <option value="completed">å®Œäº†</option>
                <option value="user_cancel">ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚­ãƒ£ãƒ³ã‚»ãƒ«</option>
                <option value="admin_cancel">ç®¡ç†å´ã‚­ãƒ£ãƒ³ã‚»ãƒ«</option>
              </select>
            </div>
          </div>

          <div class="info-grid">
            <div class="info-block">
              <div class="info-label">ç”³è«‹æƒ…å ±</div>
              <div class="info-value" id="info-user">-</div>
              <div class="wallet-row" id="info-amount">é€šè²¨: - / é‡‘é¡: -</div>
              <div class="wallet-row" id="info-ids">ID: - / method: -</div>
            </div>
            <div class="info-block">
              <div class="info-label">ãƒ¦ãƒ¼ã‚¶ãƒ¼æ®‹é«˜ï¼ˆwallet_storeï¼‰</div>
              <div class="wallet-row" id="wallet-total">ç·æ®‹é«˜: -</div>
              <div class="wallet-row" id="wallet-available">åˆ©ç”¨å¯èƒ½æ®‹é«˜: -</div>
            </div>
          </div>

          <div class="toolbar" id="toolbar" style="margin-top:8px; display:none;">
            <button class="btn-xs btn-xs-primary" id="btn-apply-status">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°ï¼ˆæ®‹é«˜åæ˜ ï¼‰</button>
          </div>
          <div class="note">
            ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ã€Œå®Œäº†ã€ã«å¤‰æ›´ã—ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã€è©²å½“ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç·æ®‹é«˜ãƒ»åˆ©ç”¨å¯èƒ½æ®‹é«˜ã«å…¥é‡‘é¡ã‚’åŠ ç®—ã—ã¾ã™ã€‚<br>
            ãƒ‡ãƒ¢ã§ã¯ localStorage ã® <code>cx_wallet_store</code> ã«åæ˜ ã•ã‚Œã¾ã™ã€‚
          </div>
        </div>
      </section>
    </div>
  </main>

  <div class="toast" id="toast"></div>

  <script>
    const TRANSFER_KEY = "cx_transfers";      // å…¥å‡ºé‡‘ç”³è«‹ä¸€è¦§
    const WALLET_KEY = "cx_wallet_store";    // æ®‹é«˜ã‚¹ãƒˆã‚¢

    const fUser = document.getElementById("f-user");
    const fCurrency = document.getElementById("f-currency");
    const fFrom = document.getElementById("f-from");
    const fTo = document.getElementById("f-to");
    const listBoxEl = document.getElementById("list-box");
    const listCountEl = document.getElementById("list-count");
    const statusTabs = document.querySelectorAll(".status-tab-btn");
    const statusSelectEl = document.getElementById("status-select");
    const detailTitleEl = document.getElementById("detail-title");
    const detailMetaEl = document.getElementById("detail-meta");
    const infoUserEl = document.getElementById("info-user");
    const infoAmountEl = document.getElementById("info-amount");
    const infoIdsEl = document.getElementById("info-ids");
    const walletTotalEl = document.getElementById("wallet-total");
    const walletAvailableEl = document.getElementById("wallet-available");
    const btnApplyStatus = document.getElementById("btn-apply-status");
    const btnRefresh = document.getElementById("btn-refresh");
    const toolbarEl = document.getElementById("toolbar");
    const toastEl = document.getElementById("toast");

    let allTransfers = [];
    let deposits = [];
    let filtered = [];
    let currentStatusFilter = "all";
    let currentId = null;

    function showToast(msg) {
      toastEl.textContent = msg;
      toastEl.classList.add("show");
      setTimeout(() => toastEl.classList.remove("show"), 2200);
    }

    function loadTransfers() {
      try {
        const raw = localStorage.getItem(TRANSFER_KEY);
        if (!raw) return seedTransfers();
        const data = JSON.parse(raw);
        if (!Array.isArray(data)) return seedTransfers();
        return data;
      } catch (e) {
        console.error(e);
        return seedTransfers();
      }
    }

    // ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ä½œæˆ
    function seedTransfers() {
      const now = Date.now();
      const sample = [
        {
          id: "dep_001",
          type: "deposit",
          userId: "user-demo-001",
          currency: "JPY",
          amount: 100000,
          status: "pending",
          createdAt: now - 3600 * 1000 * 2,
          updatedAt: now - 3600 * 1000 * 2,
          method: "bank_transfer",
          note: "",
        },
        {
          id: "dep_002",
          type: "deposit",
          userId: "user-demo-002",
          currency: "USDT",
          amount: 500,
          status: "completed",
          createdAt: now - 3600 * 1000 * 24,
          updatedAt: now - 3600 * 1000 * 20,
          method: "crypto",
          note: "",
        },
        {
          id: "wd_001",
          type: "withdraw",
          userId: "user-demo-001",
          currency: "BTC",
          amount: 0.05,
          status: "pending",
          createdAt: now - 3600 * 1000 * 3,
          updatedAt: now - 3600 * 1000 * 3,
          method: "crypto",
          note: "",
          lockApplied: false,
        },
      ];
      localStorage.setItem(TRANSFER_KEY, JSON.stringify(sample));
      return sample;
    }

    function loadWalletStore() {
      try {
        const raw = localStorage.getItem(WALLET_KEY);
        if (!raw) return {};
        const data = JSON.parse(raw);
        return data && typeof data === "object" ? data : {};
      } catch (e) {
        console.error(e);
        return {};
      }
    }

    function saveWalletStore(store) {
      localStorage.setItem(WALLET_KEY, JSON.stringify(store));
    }

    function getWallet(store, userId, currency) {
      if (!store[userId]) store[userId] = {};
      if (!store[userId][currency]) {
        store[userId][currency] = { total: 0, available: 0 };
      }
      return store[userId][currency];
    }

    function formatAmount(amount, currency) {
      if (amount == null) return "-";
      if (currency === "JPY") {
        return amount.toLocaleString("ja-JP") + " " + currency;
      }
      return amount.toLocaleString("en-US", {
        minimumFractionDigits: 4,
        maximumFractionDigits: 8,
      }) + " " + currency;
    }

    function applyFilters() {
      const uid = fUser.value.trim().toLowerCase();
      const cur = fCurrency.value;
      const fromVal = fFrom.value;
      const toVal = fTo.value;

      filtered = deposits.filter((t) => {
        if (currentStatusFilter !== "all" && t.status !== currentStatusFilter) {
          return false;
        }
        if (uid) {
          if (!t.userId || !t.userId.toLowerCase().includes(uid)) return false;
        }
        if (cur !== "all" && t.currency !== cur) return false;
        if (fromVal) {
          const fromTs = new Date(fromVal + "T00:00:00").getTime();
          if ((t.createdAt || 0) < fromTs) return false;
        }
        if (toVal) {
          const toTs = new Date(toVal + "T23:59:59").getTime();
          if ((t.createdAt || 0) > toTs) return false;
        }
        return true;
      });

      filtered.sort((a, b) => (b.updatedAt || 0) - (a.updatedAt || 0));
      renderList();
    }

    function renderList() {
      listBoxEl.innerHTML = "";
      listCountEl.textContent = filtered.length + "ä»¶";

      if (filtered.length === 0) {
        listBoxEl.innerHTML =
          '<div style="font-size:12px; color:var(--text-muted); text-align:center; padding:30px 4px;">è©²å½“ã™ã‚‹å…¥é‡‘ç”³è«‹ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>';
        currentId = null;
        renderDetail();
        return;
      }

      filtered.forEach((t) => {
        const div = document.createElement("div");
        div.className = "item-row" + (t.id === currentId ? " active" : "");
        div.dataset.id = t.id;
        const created = t.createdAt
          ? new Date(t.createdAt).toLocaleString("ja-JP", { hour12: false })
          : "-";
        const statusClass = "status-" + t.status;
        const statusLabel = statusLabelFor(t.status);

        div.innerHTML = `
          <div>
            <div class="item-title">${t.userId || "-"} / ${t.currency}</div>
            <div class="item-meta">
              é‡‘é¡: ${formatAmount(t.amount, t.currency)}<br>
              ä½œæˆ: ${created}
            </div>
          </div>
          <div style="text-align:right;">
            <div class="status-chip ${statusClass}">${statusLabel}</div>
            <div class="item-meta">ID: ${t.id}</div>
          </div>
        `;
        div.addEventListener("click", () => {
          currentId = t.id;
          renderList();
          renderDetail();
        });
        listBoxEl.appendChild(div);
      });

      if (!currentId && filtered.length > 0) {
        currentId = filtered[0].id;
        renderList();
        renderDetail();
      }
    }

    function statusLabelFor(s) {
      switch (s) {
        case "pending": return "ç”³è«‹ä¸­";
        case "completed": return "å®Œäº†";
        case "user_cancel": return "ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚­ãƒ£ãƒ³ã‚»ãƒ«";
        case "admin_cancel": return "ç®¡ç†å´ã‚­ãƒ£ãƒ³ã‚»ãƒ«";
        default: return s;
      }
    }

    function renderDetail() {
      const t = deposits.find((x) => x.id === currentId);
      const walletStore = loadWalletStore();

      if (!t) {
        detailTitleEl.textContent = "ç”³è«‹ã‚’é¸æŠã—ã¦ãã ã•ã„";
        detailMetaEl.textContent =
          "å·¦ã®ä¸€è¦§ã‹ã‚‰å…¥é‡‘ç”³è«‹ã‚’é¸æŠã™ã‚‹ã¨ã€è©³ç´°ã¨æ®‹é«˜ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚";
        infoUserEl.textContent = "-";
        infoAmountEl.textContent = "é€šè²¨: - / é‡‘é¡: -";
        infoIdsEl.textContent = "ID: - / method: -";
        walletTotalEl.textContent = "ç·æ®‹é«˜: -";
        walletAvailableEl.textContent = "åˆ©ç”¨å¯èƒ½æ®‹é«˜: -";
        statusSelectEl.disabled = true;
        toolbarEl.style.display = "none";
        return;
      }

      detailTitleEl.textContent = `å…¥é‡‘ç”³è«‹ ${t.id}`;
      const created = t.createdAt
        ? new Date(t.createdAt).toLocaleString("ja-JP", { hour12: false })
        : "-";
      const updated = t.updatedAt
        ? new Date(t.updatedAt).toLocaleString("ja-JP", { hour12: false })
        : "-";

      detailMetaEl.innerHTML =
        `<span>ãƒ¦ãƒ¼ã‚¶ãƒ¼ID: ${t.userId || "-"}</span>` +
        `<span>ä½œæˆ: ${created}</span><br>` +
        `<span>æ›´æ–°: ${updated}</span>`;

      infoUserEl.textContent = t.userId || "-";
      infoAmountEl.textContent =
        `é€šè²¨: ${t.currency} / é‡‘é¡: ${formatAmount(t.amount, t.currency)}`;
      infoIdsEl.textContent =
        `ID: ${t.id} / method: ${t.method || "-"}`;

      const w = getWallet(walletStore, t.userId, t.currency);
      walletTotalEl.textContent =
        "ç·æ®‹é«˜: " + formatAmount(w.total, t.currency);
      walletAvailableEl.textContent =
        "åˆ©ç”¨å¯èƒ½æ®‹é«˜: " + formatAmount(w.available, t.currency);

      statusSelectEl.value = t.status;
      statusSelectEl.disabled = false;
      toolbarEl.style.display = "block";
    }

    function applyStatus() {
      const t = deposits.find((x) => x.id === currentId);
      if (!t) return;

      const newStatus = statusSelectEl.value;
      const oldStatus = t.status;
      if (oldStatus === newStatus) {
        showToast("ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¯å¤‰æ›´ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
        return;
      }

      const walletStore = loadWalletStore();
      const w = getWallet(walletStore, t.userId, t.currency);

      // å…¥é‡‘ï¼šcompleted ã«ãªã£ãŸæ™‚ã«æ®‹é«˜ã‚’åæ˜ 
      if (oldStatus !== "completed" && newStatus === "completed") {
        w.total += t.amount;
        w.available += t.amount;
      } else if (oldStatus === "completed" && newStatus !== "completed") {
        // ãƒ‡ãƒ¢ç”¨ï¼šå®Œäº†ã‹ã‚‰ä»–ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«æˆ»ã™å ´åˆã¯å·»ãæˆ»ã™
        w.total -= t.amount;
        w.available -= t.amount;
      }

      t.status = newStatus;
      t.updatedAt = Date.now();

      saveWalletStore(walletStore);
      localStorage.setItem(TRANSFER_KEY, JSON.stringify(allTransfers));
      showToast(`ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ã€Œ${statusLabelFor(newStatus)}ã€ã«æ›´æ–°ã—ã€æ®‹é«˜ã‚’åæ˜ ã—ã¾ã—ãŸã€‚`);

      deposits = allTransfers.filter((x) => x.type === "deposit");
      applyFilters();
    }

    function initDates() {
      const today = new Date();
      const isoToday = today.toISOString().slice(0, 10);
      const weekAgo = new Date(today.getTime() - 6 * 24 * 60 * 60 * 1000);
      fTo.value = isoToday;
      fFrom.value = weekAgo.toISOString().slice(0, 10);
    }

    function init() {
      allTransfers = loadTransfers();
      deposits = allTransfers.filter((t) => t.type === "deposit");
      initDates();
      applyFilters();
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆ
    statusTabs.forEach((btn) => {
      btn.addEventListener("click", () => {
        statusTabs.forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");
        currentStatusFilter = btn.dataset.status || "all";
        applyFilters();
      });
    });
    [fUser, fCurrency, fFrom, fTo].forEach((el) =>
      el.addEventListener("change", applyFilters)
    );
    btnApplyStatus.addEventListener("click", applyStatus);
    btnRefresh.addEventListener("click", init);

    init();
  </script>
</body>
</html>
