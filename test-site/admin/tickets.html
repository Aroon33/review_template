<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>CryptoX Admin - å•ã„åˆã‚ã›ç®¡ç†</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #f3f4f6;
      --bg-soft: #ffffff;
      --primary: #1652f0;
      --primary-soft: #e5edff;
      --text-main: #111827;
      --text-muted: #6b7280;
      --border-soft: #e5e7eb;
      --danger: #dc2626;
      --success: #16a34a;
      --pending: #f97316;
    }
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    body {
      background: var(--bg);
      color: var(--text-main);
    }
    a { text-decoration: none; color: inherit; }

    /* Header */
    .admin-header {
      position: fixed;
      top: 0; left: 0; right: 0;
      height: 52px;
      background: #ffffff;
      border-bottom: 1px solid var(--border-soft);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 18px 0 60px;
      z-index: 30;
    }
    .admin-header-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .logo-badge {
      width: 26px; height: 26px;
      border-radius: 8px;
      background: var(--primary);
      display: flex; align-items: center; justify-content: center;
      color: #fff; font-weight: 700; font-size: 14px;
    }
    .logo-text { font-weight: 700; font-size: 16px; }
    .logo-sub { font-size: 11px; color: var(--text-muted); }

    .admin-header-right {
      display: flex; align-items: center; gap: 10px;
      font-size: 11px; color: var(--text-muted);
    }
    .btn {
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 11px;
      border: 1px solid transparent;
      cursor: pointer;
      background: transparent;
    }
    .btn-outline {
      border-color: var(--border-soft);
      background: #fff;
      color: var(--text-main);
    }
    .btn-primary {
      background: var(--primary);
      color: #fff;
    }
    .btn-sm { padding: 4px 10px; font-size: 11px; }

    /* Sidebar */
    .sidebar {
      position: fixed;
      top: 0; left: 0; bottom: 0;
      width: 200px;
      background: #0f172a;
      color: #e5e7eb;
      padding-top: 52px;
      display: flex;
      flex-direction: column;
      border-right: 1px solid #020617;
      z-index: 20;
    }
    .sidebar-title {
      padding: 10px 14px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #6b7280;
    }
    .nav-list {
      list-style: none;
      margin: 0;
      padding: 0 8px 12px;
    }
    .nav-item { margin-bottom: 4px; }
    .nav-link {
      display: flex; align-items: center; gap: 8px;
      padding: 7px 8px;
      border-radius: 8px;
      font-size: 12px;
      color: #9ca3af;
      cursor: pointer;
    }
    .nav-link:hover {
      background: rgba(148, 163, 184, 0.15);
      color: #e5e7eb;
    }
    .nav-link.active {
      background: #111827;
      color: #e5e7eb;
      border: 1px solid rgba(129, 140, 248, 0.5);
    }
    .nav-icon {
      width: 14px;
      text-align: center;
      font-size: 12px;
    }
    .sidebar-footer {
      margin-top: auto;
      padding: 10px 14px 12px;
      font-size: 11px;
      color: #6b7280;
      border-top: 1px solid rgba(31, 41, 55, 0.9);
    }

    /* Main layout */
    .main {
      margin-left: 200px;
      padding-top: 52px;
    }
    .main-inner {
      max-width: 1120px;
      margin: 0 auto;
      padding: 16px 18px 24px;
    }
    .page-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .page-sub {
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 10px;
    }

    /* Filters */
    .filters-card {
      background: var(--bg-soft);
      border-radius: 10px;
      border: 1px solid var(--border-soft);
      padding: 10px 12px 8px;
      box-shadow: 0 1px 2px rgba(15,23,42,0.03);
      margin-bottom: 10px;
    }
    .filters-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .filters-title { font-size: 13px; font-weight: 600; }
    .filters-meta { font-size: 11px; color: var(--text-muted); }
    .filters-grid {
      display: grid;
      grid-template-columns: minmax(0, 0.9fr) minmax(0, 0.6fr) minmax(0, 0.7fr);
      gap: 8px;
    }
    @media (max-width: 900px) {
      .filters-grid {
        grid-template-columns: 1fr;
      }
    }
    .field {
      display: flex;
      flex-direction: column;
      gap: 2px;
      font-size: 11px;
    }
    .field label { color: var(--text-muted); }
    .field input,
    .field select {
      border-radius: 6px;
      border: 1px solid var(--border-soft);
      padding: 6px 7px;
      font-size: 11px;
      outline: none;
      background: #fff;
    }
    .field input:focus,
    .field select:focus { border-color: var(--primary); }

    .status-tabs {
      display: inline-flex;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      overflow: hidden;
      font-size: 11px;
    }
    .status-tab-btn {
      padding: 4px 10px;
      border: none;
      background: #fff;
      color: var(--text-muted);
      cursor: pointer;
    }
    .status-tab-btn.active {
      background: var(--primary);
      color: #fff;
    }

    /* Two-pane layout */
    .pane-grid {
      display: grid;
      grid-template-columns: minmax(0, 0.9fr) minmax(0, 1.3fr);
      gap: 10px;
    }
    @media (max-width: 900px) {
      .pane-grid {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: var(--bg-soft);
      border-radius: 10px;
      border: 1px solid var(--border-soft);
      box-shadow: 0 1px 2px rgba(15,23,42,0.03);
      padding: 10px 11px 9px;
      font-size: 12px;
    }

    .card-header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }
    .card-title-small { font-size: 13px; font-weight: 600; }
    .card-sub-small { font-size: 11px; color: var(--text-muted); }

    /* Ticket list */
    .ticket-list {
      max-height: 420px;
      overflow-y: auto;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
    }
    .ticket-item {
      padding: 7px 8px;
      border-bottom: 1px solid #e5e7eb;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: flex-start;
      background: #ffffff;
    }
    .ticket-item:nth-child(2n) { background: #f9fafb; }
    .ticket-item:last-child { border-bottom: none; }
    .ticket-item.active {
      background: #eef2ff;
      border-left: 3px solid var(--primary);
    }
    .ticket-title {
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 2px;
    }
    .ticket-meta {
      font-size: 11px;
      color: var(--text-muted);
    }

    .status-chip {
      display: inline-flex;
      align-items: center;
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 10px;
      font-weight: 500;
    }
    .status-new { background: #fee2e2; color: var(--danger); }
    .status-open { background: #ffedd5; color: var(--pending); }
    .status-closed { background: #dcfce7; color: var(--success); }

    /* Detail / chat */
    .detail-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 8px;
      margin-bottom: 6px;
    }
    .detail-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 2px;
    }
    .detail-meta {
      font-size: 11px;
      color: var(--text-muted);
    }
    .detail-meta span { margin-right: 8px; }

    .status-select {
      font-size: 11px;
      padding: 4px 6px;
      border-radius: 6px;
      border: 1px solid var(--border-soft);
      outline: none;
    }
    .status-select:focus { border-color: var(--primary); }

    .chat-window {
      border-radius: 8px;
      border: 1px solid var(--border-soft);
      background: #f9fafb;
      height: 260px;
      overflow-y: auto;
      padding: 7px 8px 5px;
      margin-bottom: 6px;
    }
    .chat-empty {
      font-size: 12px;
      color: var(--text-muted);
      text-align: center;
      margin-top: 80px;
    }
    .msg {
      max-width: 80%;
      margin-bottom: 6px;
      padding: 6px 8px;
      border-radius: 10px;
      font-size: 12px;
      line-height: 1.4;
    }
    .msg-user {
      background: #e5e7eb;
      margin-right: auto;
      border-bottom-left-radius: 2px;
    }
    .msg-admin {
      background: #dbeafe;
      margin-left: auto;
      border-bottom-right-radius: 2px;
    }
    .msg-meta {
      font-size: 10px;
      color: #6b7280;
      margin-top: 2px;
      text-align: right;
    }

    .reply-area {
      margin-top: 2px;
    }
    .reply-row {
      display: flex;
      gap: 6px;
      margin-bottom: 4px;
    }
    .reply-row textarea {
      flex: 1;
      min-height: 48px;
      resize: vertical;
      border-radius: 6px;
      border: 1px solid var(--border-soft);
      padding: 6px 7px;
      font-size: 12px;
      outline: none;
    }
    .reply-row textarea:focus { border-color: var(--primary); }
    .note {
      font-size: 10px;
      color: var(--text-muted);
    }

    .btn-xs-primary {
      padding: 5px 10px;
      border-radius: 999px;
      border: none;
      font-size: 11px;
      cursor: pointer;
      background: var(--primary);
      color: #fff;
    }
    .btn-xs-outline {
      padding: 5px 10px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      font-size: 11px;
      cursor: pointer;
      background: #fff;
      color: var(--text-main);
    }

    .toolbar {
      display: flex;
      gap: 6px;
      justify-content: flex-end;
      margin-bottom: 4px;
    }

    .toast {
      position: fixed;
      right: 16px;
      bottom: 16px;
      background: #111827;
      color: #f9fafb;
      padding: 8px 14px;
      border-radius: 999px;
      font-size: 11px;
      display: none;
      z-index: 50;
    }
    .toast.show { display: block; }

    @media (max-width: 768px) {
      .admin-header { padding-left: 54px; }
      .sidebar { width: 180px; }
      .main { margin-left: 180px; }
    }
    @media (max-width: 640px) {
      .sidebar { transform: translateX(-100%); }
      .main { margin-left: 0; }
      .admin-header { padding-left: 12px; }
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-title">ãƒ¡ãƒ‹ãƒ¥ãƒ¼</div>
    <ul class="nav-list">
      <li class="nav-item">
        <a href="index.html" class="nav-link">
          <span class="nav-icon">ğŸ </span><span>ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</span>
        </a>
      </li>
      <li class="nav-item">
        <a href="tickets.html" class="nav-link active">
          <span class="nav-icon">ğŸ’¬</span><span>å•ã„åˆã‚ã›ç®¡ç†</span>
        </a>
      </li>
      <li class="nav-item">
        <a href="users.html" class="nav-link">
          <span class="nav-icon">ğŸ‘¥</span><span>ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§</span>
        </a>
      </li>
      <li class="nav-item">
        <a href="trades.html" class="nav-link">
          <span class="nav-icon">ğŸ“Š</span><span>å–å¼•çŠ¶æ³</span>
        </a>
      </li>
       <li class="nav-item">
        <a href="kyc.html" class="nav-link">
          <span class="nav-icon">ğŸ“Š</span><span>KYCçŠ¶æ³</span>
        </a>
      </li>
      <li class="nav-item">
        <a href="deposit.html" class="nav-link">
          <span class="nav-icon">â•</span><span>å…¥é‡‘ç”³è«‹</span>
        </a>
      </li>
      <li class="nav-item">
        <a href="withdraw.html" class="nav-link">
          <span class="nav-icon">â–</span><span>å‡ºé‡‘ç”³è«‹</span>
        </a>
      </li>
      <li class="nav-item">
        <a href="group.html" class="nav-link">
          <span class="nav-icon">ğŸ§©</span><span>ã‚°ãƒ«ãƒ¼ãƒ—ç®¡ç†</span>
        </a>
      </li>
      <li class="nav-item">
        <a href="settings.html" class="nav-link">
          <span class="nav-icon">âš™ï¸</span><span>ã‚·ã‚¹ãƒ†ãƒ è¨­å®š</span>
        </a>
      </li>
    </ul>
    <div class="sidebar-footer">
      CryptoX Admin<br />UI Demo &copy; 2025
    </div>
  </aside>

  <!-- Header -->
  <header class="admin-header">
    <div class="admin-header-left">
      <div class="logo-badge">AX</div>
      <div>
        <div class="logo-text">Admin Console</div>
        <div class="logo-sub">å•ã„åˆã‚ã›ç®¡ç†</div>
      </div>
    </div>
    <div class="admin-header-right">
      <span>ç®¡ç†è€…ï¼šadmin@example.com</span>
      <button class="btn btn-outline btn-sm" onclick="location.href='login.html'">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆï¼ˆãƒ‡ãƒ¢ï¼‰</button>
    </div>
  </header>

  <!-- Main -->
  <main class="main">
    <div class="main-inner">
      <div class="page-title">å•ã„åˆã‚ã›ç®¡ç†</div>
      <div class="page-sub">
        ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®å•ã„åˆã‚ã›ã‚’ä¸€è¦§ãƒ»æ¤œç´¢ã—ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´ã‚„ãƒãƒ£ãƒƒãƒˆè¿”ä¿¡ã‚’è¡Œã†ãƒ‡ãƒ¢ç”»é¢ã§ã™ã€‚
      </div>

      <!-- Filters -->
      <section class="filters-card">
        <div class="filters-row">
          <div>
            <div class="filters-title">ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</div>
            <div class="filters-meta">
              ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ»ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãƒ»æœŸé–“ã§ãƒã‚±ãƒƒãƒˆã‚’çµã‚Šè¾¼ã¿ã¾ã™ã€‚
            </div>
          </div>
          <div class="status-tabs">
            <button class="status-tab-btn active" data-status="all">ã™ã¹ã¦</button>
            <button class="status-tab-btn" data-status="new">æœªå¯¾å¿œ</button>
            <button class="status-tab-btn" data-status="open">å¯¾å¿œä¸­</button>
            <button class="status-tab-btn" data-status="closed">å¯¾å¿œæ¸ˆ</button>
          </div>
        </div>
        <div class="filters-grid">
          <div class="field">
            <label>ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆä»¶åãƒ»æœ¬æ–‡ï¼‰</label>
            <input type="text" id="f-keyword" placeholder="ä¾‹ï¼šå…¥é‡‘ / ã‚¨ãƒ©ãƒ¼ / ã‚·ã‚¹ãƒ†ãƒ å–å¼•" />
          </div>
          <div class="field">
            <label>ãƒ¦ãƒ¼ã‚¶ãƒ¼ID</label>
            <input type="text" id="f-user" placeholder="ä¾‹ï¼šuser-demo-001" />
          </div>
          <div class="field">
            <label>æœŸé–“ï¼ˆFromï¼‰</label>
            <input type="date" id="f-from" />
          </div>
          <div class="field">
            <label>æœŸé–“ï¼ˆToï¼‰</label>
            <input type="date" id="f-to" />
          </div>
        </div>
      </section>

      <!-- Two panes -->
      <section class="pane-grid">
        <!-- Left: list -->
        <div class="card">
          <div class="card-header-row">
            <div>
              <div class="card-title-small">å•ã„åˆã‚ã›ä¸€è¦§</div>
              <div class="card-sub-small" id="list-count">0ä»¶</div>
            </div>
            <button class="btn-xs-outline" id="btn-refresh">å†èª­ã¿è¾¼ã¿</button>
          </div>
          <div class="ticket-list" id="ticket-list">
            <!-- JS -->
          </div>
        </div>

        <!-- Right: detail & chat -->
        <div class="card">
          <div class="detail-header">
            <div>
              <div class="detail-title" id="detail-title">å•ã„åˆã‚ã›ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
              <div class="detail-meta" id="detail-meta">
                å·¦å´ã®ä¸€è¦§ã‹ã‚‰ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’é¸æŠã™ã‚‹ã¨ã€ã“ã“ã«è©³ç´°ã¨ãƒãƒ£ãƒƒãƒˆå±¥æ­´ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
              </div>
            </div>
            <div>
              <div style="font-size:11px; color:var(--text-muted); margin-bottom:2px;">
                ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
              </div>
              <select class="status-select" id="status-select" disabled>
                <option value="new">æœªå¯¾å¿œ</option>
                <option value="open">å¯¾å¿œä¸­</option>
                <option value="closed">å¯¾å¿œæ¸ˆ</option>
              </select>
            </div>
          </div>

          <div class="chat-window" id="chat-window">
            <div class="chat-empty">ã¾ã ã‚¹ãƒ¬ãƒƒãƒ‰ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</div>
          </div>

          <div class="reply-area" id="reply-area" style="display:none;">
            <div class="toolbar">
              <button class="btn-xs-outline" id="btn-close-ticket">å¯¾å¿œæ¸ˆã¨ã—ã¦ã‚¯ãƒ­ãƒ¼ã‚º</button>
            </div>
            <div class="reply-row">
              <textarea id="reply-text" placeholder="ã‚µãƒãƒ¼ãƒˆã‹ã‚‰ã®è¿”ä¿¡å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"></textarea>
              <button class="btn-xs-primary" id="btn-send-reply">è¿”ä¿¡ã‚’é€ä¿¡</button>
            </div>
            <div class="note">
              ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒã€Œå¯¾å¿œæ¸ˆã€ã«å¤‰æ›´ã•ã‚Œã‚‹ã¨ã€ã“ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã¯ã‚¯ãƒ­ãƒ¼ã‚ºã•ã‚Œã€ãƒ¦ãƒ¼ã‚¶ãƒ¼å´ã‹ã‚‰ã¯è¿½è¨˜ã§ããªããªã‚Šã¾ã™ï¼ˆãƒ‡ãƒ¢ï¼‰ã€‚
            </div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <div class="toast" id="toast"></div>

  <script>
    const STORAGE_KEY = "cx_support_threads";

    const STATUS_LABEL = {
      new: "æœªå¯¾å¿œ",
      open: "å¯¾å¿œä¸­",
      closed: "å¯¾å¿œæ¸ˆ",
    };

    const STATUS_CLASS = {
      new: "status-new",
      open: "status-open",
      closed: "status-closed",
    };

    const fKeyword = document.getElementById("f-keyword");
    const fUser = document.getElementById("f-user");
    const fFrom = document.getElementById("f-from");
    const fTo = document.getElementById("f-to");
    const ticketListEl = document.getElementById("ticket-list");
    const listCountEl = document.getElementById("list-count");
    const statusTabs = document.querySelectorAll(".status-tab-btn");
    const statusSelectEl = document.getElementById("status-select");
    const detailTitleEl = document.getElementById("detail-title");
    const detailMetaEl = document.getElementById("detail-meta");
    const chatWindowEl = document.getElementById("chat-window");
    const replyAreaEl = document.getElementById("reply-area");
    const replyTextEl = document.getElementById("reply-text");
    const btnSendReply = document.getElementById("btn-send-reply");
    const btnCloseTicket = document.getElementById("btn-close-ticket");
    const btnRefresh = document.getElementById("btn-refresh");
    const toastEl = document.getElementById("toast");

    let allThreads = [];
    let filteredThreads = [];
    let currentStatusFilter = "all";
    let currentThreadId = null;

    function showToast(msg) {
      toastEl.textContent = msg;
      toastEl.classList.add("show");
      setTimeout(() => toastEl.classList.remove("show"), 2200);
    }

    function loadThreads() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return [];
        const threads = JSON.parse(raw);
        // å½¢å¼ãƒã‚§ãƒƒã‚¯
        return Array.isArray(threads) ? threads : [];
      } catch (e) {
        console.error(e);
        return [];
      }
    }

    function saveThreads(threads) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(threads));
    }

    function applyFilters() {
      const kw = fKeyword.value.trim().toLowerCase();
      const uid = fUser.value.trim().toLowerCase();
      const fromVal = fFrom.value;
      const toVal = fTo.value;

      filteredThreads = allThreads.filter((t) => {
        if (currentStatusFilter !== "all" && t.status !== currentStatusFilter) {
          return false;
        }
        if (kw) {
          const hay =
            (t.title || "").toLowerCase() +
            " " +
            (t.messages || [])
              .map((m) => m.text || "")
              .join(" ")
              .toLowerCase();
          if (!hay.includes(kw)) return false;
        }
        if (uid) {
          const userId = (t.userId || "").toLowerCase();
          if (!userId.includes(uid)) return false;
        }
        if (fromVal) {
          const fromTs = new Date(fromVal + "T00:00:00").getTime();
          if ((t.createdAt || 0) < fromTs) return false;
        }
        if (toVal) {
          const toTs = new Date(toVal + "T23:59:59").getTime();
          if ((t.createdAt || 0) > toTs) return false;
        }
        return true;
      });

      filteredThreads.sort((a, b) => (b.updatedAt || 0) - (a.updatedAt || 0));
      renderList();
    }

    function renderList() {
      ticketListEl.innerHTML = "";
      listCountEl.textContent = filteredThreads.length + "ä»¶";

      if (filteredThreads.length === 0) {
        ticketListEl.innerHTML =
          '<div style="font-size:12px; color:var(--text-muted); text-align:center; padding:30px 4px;">è©²å½“ã™ã‚‹å•ã„åˆã‚ã›ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>';
        // é¸æŠè§£é™¤
        currentThreadId = null;
        renderDetail();
        return;
      }

      filteredThreads.forEach((t) => {
        const div = document.createElement("div");
        div.className =
          "ticket-item" + (t.id === currentThreadId ? " active" : "");
        div.dataset.id = t.id;

        const updated = t.updatedAt
          ? new Date(t.updatedAt).toLocaleString("ja-JP", {
              hour12: false,
            })
          : "-";
        const created = t.createdAt
          ? new Date(t.createdAt).toLocaleString("ja-JP", {
              hour12: false,
            })
          : "-";

        div.innerHTML = `
          <div>
            <div class="ticket-title">${escapeHtml(t.title || "ç„¡é¡Œã®å•ã„åˆã‚ã›")}</div>
            <div class="ticket-meta">
              <span>ãƒ¦ãƒ¼ã‚¶ãƒ¼ID: ${escapeHtml(t.userId || "-")}</span><br/>
              <span>ä½œæˆ: ${created}</span> / <span>æ›´æ–°: ${updated}</span>
            </div>
          </div>
          <div style="text-align:right;">
            <div class="status-chip ${STATUS_CLASS[t.status] || ""}">
              ${STATUS_LABEL[t.status] || t.status}
            </div>
            <div class="ticket-meta">ID: ${t.id.slice(-6)}</div>
          </div>
        `;

        div.addEventListener("click", () => {
          currentThreadId = t.id;
          renderList();
          renderDetail();
        });

        ticketListEl.appendChild(div);
      });

      // æœ€åˆã®1ä»¶ã‚’è‡ªå‹•é¸æŠï¼ˆä½•ã‚‚é¸ã‚“ã§ãªã‘ã‚Œã°ï¼‰
      if (!currentThreadId && filteredThreads.length > 0) {
        currentThreadId = filteredThreads[0].id;
        renderList();
        renderDetail();
      }
    }

    function renderDetail() {
      const t = allThreads.find((th) => th.id === currentThreadId);

      if (!t) {
        detailTitleEl.textContent = "å•ã„åˆã‚ã›ã‚’é¸æŠã—ã¦ãã ã•ã„";
        detailMetaEl.textContent =
          "å·¦å´ã®ä¸€è¦§ã‹ã‚‰ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’é¸æŠã™ã‚‹ã¨ã€ã“ã“ã«è©³ç´°ã¨ãƒãƒ£ãƒƒãƒˆå±¥æ­´ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚";
        chatWindowEl.innerHTML =
          '<div class="chat-empty">ã¾ã ã‚¹ãƒ¬ãƒƒãƒ‰ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</div>';
        statusSelectEl.disabled = true;
        replyAreaEl.style.display = "none";
        return;
      }

      detailTitleEl.textContent = t.title || "ç„¡é¡Œã®å•ã„åˆã‚ã›";
      const created = t.createdAt
        ? new Date(t.createdAt).toLocaleString("ja-JP", { hour12: false })
        : "-";
      const updated = t.updatedAt
        ? new Date(t.updatedAt).toLocaleString("ja-JP", { hour12: false })
        : "-";
      detailMetaEl.innerHTML = `
        <span>ã‚¹ãƒ¬ãƒƒãƒ‰ID: ${escapeHtml(t.id)}</span>
        <span>ãƒ¦ãƒ¼ã‚¶ãƒ¼ID: ${escapeHtml(t.userId || "-")}</span><br/>
        <span>ä½œæˆ: ${created}</span> / <span>æ›´æ–°: ${updated}</span>
      `;

      statusSelectEl.value = t.status || "new";
      statusSelectEl.disabled = false;

      // ãƒãƒ£ãƒƒãƒˆæç”»
      chatWindowEl.innerHTML = "";
      if (!t.messages || t.messages.length === 0) {
        chatWindowEl.innerHTML =
          '<div class="chat-empty">ã¾ã ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>';
      } else {
        t.messages.forEach((m) => {
          const wrap = document.createElement("div");
          wrap.className = "msg " + (m.from === "admin" ? "msg-admin" : "msg-user");
          const timeStr = m.at
            ? new Date(m.at).toLocaleString("ja-JP", { hour12: false })
            : "";
          wrap.innerHTML = `
            <div>${escapeHtml(m.text || "")}</div>
            <div class="msg-meta">${
              m.from === "admin" ? "ã‚µãƒãƒ¼ãƒˆ" : "ãƒ¦ãƒ¼ã‚¶ãƒ¼"
            } ãƒ» ${timeStr}</div>
          `;
          chatWindowEl.appendChild(wrap);
        });
        chatWindowEl.scrollTop = chatWindowEl.scrollHeight;
      }

      // å¯¾å¿œæ¸ˆã¿ãªã‚‰è¿”ä¿¡ä¸å¯
      if (t.status === "closed") {
        replyAreaEl.style.display = "none";
      } else {
        replyAreaEl.style.display = "block";
      }
    }

    function changeStatus(newStatus) {
      if (!currentThreadId) return;
      const idx = allThreads.findIndex((t) => t.id === currentThreadId);
      if (idx === -1) return;

      allThreads[idx].status = newStatus;
      allThreads[idx].updatedAt = Date.now();

      saveThreads(allThreads);
      applyFilters();
      renderDetail();

      showToast(`ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ã€Œ${STATUS_LABEL[newStatus]}ã€ã«å¤‰æ›´ã—ã¾ã—ãŸã€‚`);
    }

    function sendReply() {
      if (!currentThreadId) return;
      const text = replyTextEl.value.trim();
      if (!text) return;

      const idx = allThreads.findIndex((t) => t.id === currentThreadId);
      if (idx === -1) return;

      const now = Date.now();
      allThreads[idx].messages = allThreads[idx].messages || [];
      allThreads[idx].messages.push({
        from: "admin",
        text,
        at: now,
      });
      allThreads[idx].updatedAt = now;

      // æœªå¯¾å¿œã ã£ãŸã‚‰å¯¾å¿œä¸­ã¸
      if (allThreads[idx].status === "new") {
        allThreads[idx].status = "open";
      }

      saveThreads(allThreads);
      replyTextEl.value = "";
      applyFilters();
      renderDetail();
      showToast("è¿”ä¿¡ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚ï¼ˆãƒ‡ãƒ¢ï¼‰");
    }

    function closeTicket() {
      if (!currentThreadId) return;
      changeStatus("closed");
    }

    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, (s) => ({
        "&": "&amp;",
        "<": "&lt;",
        ">": "&gt;",
        '"': "&quot;",
        "'": "&#39;",
      }[s]));
    }

    // Event bindings
    statusTabs.forEach((btn) => {
      btn.addEventListener("click", () => {
        statusTabs.forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");
        currentStatusFilter = btn.dataset.status || "all";
        applyFilters();
      });
    });

    [fKeyword, fUser, fFrom, fTo].forEach((el) => {
      el.addEventListener("change", applyFilters);
    });

    statusSelectEl.addEventListener("change", (e) => {
      changeStatus(e.target.value);
    });

    btnSendReply.addEventListener("click", sendReply);
    btnCloseTicket.addEventListener("click", closeTicket);
    btnRefresh.addEventListener("click", init);

    function initDates() {
      const today = new Date();
      const isoToday = today.toISOString().slice(0, 10);
      const weekAgo = new Date(today.getTime() - 6 * 24 * 60 * 60 * 1000);
      const isoWeekAgo = weekAgo.toISOString().slice(0, 10);
      fTo.value = isoToday;
      fFrom.value = isoWeekAgo;
    }

    function init() {
      allThreads = loadThreads();
      initDates();
      applyFilters();
    }

    init();
  </script>
</body>
</html>
